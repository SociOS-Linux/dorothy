#!/usr/bin/env bash
source "$HOME/.scripts/sources/strict.bash"

# https://developers.cloudflare.com/1.1.1.1/dns-over-https/cloudflared-proxy/
# https://developers.cloudflare.com/argo-tunnel/downloads/

function cloudflare_install {
	if command-exists cloudflared; then
		echo 'cloudflared already installed'
	else
		echo 'installing cloudflared'
		if is-mac; then
			brew install cloudflare/cloudflare/cloudflared
		else
			stderr echo 'installation of cloudflared not yet added for non-macos platforms'
			return 1
		fi
	fi
}

function cloudflare_service {
	if is-file "/usr/local/etc/cloudflared/config.yml"; then
		echo 'cloudflared already configured'
	else
		echo 'configuring cloudflared as service'
		mkdir -p /usr/local/etc/cloudflared
		cat << EOF > /usr/local/etc/cloudflared/config.yml
proxy-dns: true
proxy-dns-upstream:
  - https://1.1.1.1/dns-query
  - https://1.0.0.1/dns-query

EOF
		sudo cloudflared service install
		sudo launchctl start com.cloudflare.cloudflared
	fi
}

function cloudflare_configured {
	out="$(dig -x google.com)"
	if echo "$out" | grep ";; SERVER: 127.0.0.1#53(127.0.0.1)"; then
		echo 'cloudflared is configured and running correctly'
	else
		echo 'cloudflared did not appear to be setup correctly'
		return 1
	fi
}

if cloudflare_configured || (cloudflare_install && cloudflare_service && flush-dns 127.0.0.1 && cloudflare_configured); then
	echo 'dns setup now complete'
else
	flush-dns 1.1.1.1
	echo 'failed to setup dns'
fi