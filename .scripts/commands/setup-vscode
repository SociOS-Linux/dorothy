#!/usr/bin/env bash
set -e

# Check
if ! command_exists code; then
	echo -e "\nVisual Studio Code (code) does not seem to be installed..."
	exit
fi

# User
source "$HOME/.scripts/sources/user.sh"

# Helper
function vscodeinstall {
	for ARG in "$@"; do
		code --install-extension "$ARG"
	done
}

# Correct settings
echo -e "\nSymlinking settings..."
if is_mac; then
	T="$HOME/Library/Application Support/Code/User"
elif is_linux; then
	T="$HOME/.config/Code/User"
else
	echo 'unknown environment'
	exit 1
fi
S="$HOME/.scripts/users/$(whoami)/vscode"
lnsafe "$S/settings.json" "$T/settings.json"

# Install extensions
echo -e "\nInstalling Visual Studio Code extensions..."
if test -n "$VSCODE_INSTALL"; then
	# shellcheck disable=SC2086
	vscodeinstall $VSCODE_INSTALL
fi

# Customise
echo -e "\nCustomising Visual Studio Code settings..."

# Customise settings
ln -f "$HOME/.vscode/settings.json" "$HOME/Library/Application Support/Code/User/settings.json"
ln -f "$HOME/.vscode/keybindings.json" "$HOME/Library/Application Support/Code/User/keybindings.json"

# Customise stylesheets
app=$(getapp Visual Studio Code.app)

# https://github.com/Microsoft/vscode/issues/1896#issuecomment-283858289
if false; then  # doesn't seem necessary with recent vscode updates
	stylesheet="$app/Contents/Resources/app/out/vs/workbench/workbench.main.css"
	if is_file "$stylesheet"; then
		if silent grep 'fix font rendering' < "$stylesheet"; then
			echo "setup already completed"
		else
			echo "
			/* fix font rendering */
			.monaco-editor {
				-webkit-font-smoothing: antialiased !important;
				text-rendering: optimizeLegibility !important;
			}" >> "$stylesheet"
			echo "setup completed"
		fi
	else
		echo "vscode not installed"
	fi
fi

# https://github.com/akamud/vscode-theme-onelight/pull/2
stylesheet=$(expandpath "$HOME/.vscode/extensions/akamud.vscode-theme-onelight-*")
stylesheet="$stylesheet/themes/OneLight.json"
if is_file "$stylesheet"; then
	echo "fixing theme"
	sed -e 's/#FAFAFA/#FFFFFF/' -e 's/#F2F2F2/#F5F5F5/' < "$stylesheet" > "$stylesheet.tmp"
	mv -f "$stylesheet.tmp" "$stylesheet"
	echo "fixed theme"
else
	echo "theme not installed"
fi