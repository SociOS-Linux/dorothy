#!/usr/bin/env bash
source "$HOME/.scripts/sources/strict.bash"

# user
skip='errlop pluginloader pluginclerk query-engine editions getcontributors getrepos getmembers getpackages caterpillar-examples boundation bindsource gitclone-robust textandbinaryextensions workers awesome-crypto awesome-travis base billing designs legal fountain website staticsitegenerators-list staticsitegenerators-website terraform-scaleway-hashistack'
start="${1:-}"

# local
if test -z "$start"; then
	ready='yes'
else
	ready='no'
fi

# use a file at fd 3, as otherwise the repos will be passed as stdin into boundation
# http://mywiki.wooledge.org/BashFAQ/089
# https://stackoverflow.com/a/8334759/130638
f="$(mktemp)"
fetch https://bevry.me/api/github/repos | json -a > "$f"

while read -r repo <&3; do
	if test "$repo" = "$start"; then
		echo "now ready after $repo"
		ready='yes'
	elif test "$ready" = "yes"; then
		if contains-string "$skip" "$repo"; then
			echo "ignoring $repo"
		else
			echo ''
			echo "upgrading $repo"
			ok rm -Rf "$repo"
			hub clone bevry/"$repo"
			cd "$repo" || exit
			boundation-upgrade --auto --lts
			cd .. || exit
			rm -Rf "$repo"
			echo ''
		fi
	else
		echo "skipping $repo"
	fi
done 3<"$f"