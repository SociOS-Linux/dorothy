#!/usr/bin/env bash
set -e

if test "$1" == "update"; then
	mode="update"
else
	mode="install"
fi

# Setup install functions
function brewinstall {
	brew install "$@"
}
function slowbrewinstall {
	# if we are on /usr/local then we are using bottles, which are pre-compiled, and are fast
	if test "$(brew --prefix)" == "/usr/local"; then
		brewinstall "$@"
	else
		# otherwise we are on a custom directory, can't use bottles, so have to compile ourselves, which takes forever
		echo; if confirm "Do you want to install [$*]? These can take hours, so best left overnight..."; then
			echo "$*"
			brewinstall "$@"
		fi
	fi
}
function confirmbrewinstall {
	for ARG in "$@"; do
		if confirm "Do you want to install: $ARG"; then
			brewinstall "$ARG"
		fi
	done
}
function confirmcaskinstall {
	for ARG in "$@"; do
		if confirm "Do you want to install the desktop application: $ARG"; then
			brew cask install "$ARG"
		fi
	done
}

# Setup brew
if command_exists brew; then
	echo -e "\nHomebrew is already installed, great"
else
	# recomended installation method, it is pretty much the only one that works properly
	# https://github.com/balupton/dotfiles/commit/fff6fbc079aaa6ab9bb8438e02c307ebad46fd75
	# https://github.com/balupton/dotfiles/commit/69dbbe81bf30f9e0d9a1dd1d00eca3f3c88b943b
	echo -e "\nInstalling homebrew via its recomended method..."
	ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi

# Setup any custom brew directories
if is_string "$BREW_APPDIR"; then
	mkdir -p "$BREW_APPDIR"
fi
if is_string "$BREW_CASKROOM"; then
	mkdir -p "$BREW_CASKROOM"
fi

echo -e "\nInitialising homebrew cask..."
brew tap caskroom/cask
brew tap caskroom/fonts

echo -e "\nUpdating homebrew..."
brew update
brew upgrade

echo -e "\nInstalling command line applications via homebrew..."
brew install \
	aria2 \
	azure-cli \
	bash \
	bash-completion \
	fish \
	git \
	git-extras \
	heroku \
	hub \
	kryptco/tap/kr \
	mas \
	micro \
	python \
	rmtrash \
	ruby \
	terminal-notifier \
	terraform \
	tmux \
	tree \
	vault \
	vim \
	watch \
	watchman \
	wget \
	;

slowbrewinstall \
	gpg \
	shellcheck \
	;

echo; if test "$mode" == "install" && confirm "Do you want to install encoding tools?"; then
	# https://trac.ffmpeg.org/wiki/CompilationGuide/MacOSX
	brew install \
		automake \
		fdk-aac \
		git \
		jpeg \
		lame \
		libass \
		libtool \
		libvorbis \
		libvpx \
		opus \
		sdl \
		shtool \
		texi2html \
		theora \
		wget \
		x264 \
		x265 \
		xvid \
		yasm \
		;
	brew install ffmpeg --with-fdk-aac --with-tools --with-freetype --with-libass --with-libvorbis --with-libvpx --with-x265
	brew install youtube-dl libav
fi

echo; if test "$mode" == "install" && confirm "Do you want to be presented with desktop appplications to install via homebrew cask?"; then
	confirmcaskinstall \
		airparrot \
		appzapper \
		atom \
		backblaze \
		bartender \
		brave \
		burn \
		calibre \
		caption \
		ccleaner \
		contexts \
		dat \
		devdocs \
		firefox \
		freedom \
		geekbench \
		github-desktop \
		google-chrome \
		google-hangouts \
		jaikoz \
		kodi \
		little-snitch \
		loopback \
		micro-snitch \
		opera \
		plex-media-server \
		pomello \
		reflector \
		screenflow \
		sketch \
		skype \
		soundsource \
		spotifree \
		spotify \
		teamviewer \
		toggldesktop \
		torbrowser \
		tower \
		transmission \
		tunnelbear \
		usage \
		visual-studio-code \
		vlc \
		vmware-fusion \
		windscribe \
		xld \
		undercover \
		;
fi
