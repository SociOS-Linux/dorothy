#!/usr/bin/env bash
source "$HOME/.scripts/sources/strict.bash"

# https://developers.cloudflare.com/1.1.1.1/dns-over-https/cloudflared-proxy/
# https://developers.cloudflare.com/argo-tunnel/downloads/

function aghome_install {
	if command-exists AdGuardHome; then
		echo 'adguard home already installed'
	else
		down-zip-file "https://github.com/AdguardTeam/AdGuardHome/releases/download/v0.101.0/AdGuardHome_MacOS.zip" "AdGuardHome" "$HOME/bin/AdGuardHome"
		chmod +x "$HOME/bin/AdGuardHome"
	fi
}

function aghome_uninstall {
	ok sudo AdGuardHome -s uninstall
	ok rm -vi "$HOME/bin/AdGuardHome"*
}

function aghome_service {
	ok sudo AdGuardHome -s uninstall
	sudo AdGuardHome -s install
	confirm "Press any key once you have completed the AdGuard Home setup..."
}

function aghome_setup {
	aghome_install && aghome_service
}

function cloudflare_install {
	if command-exists cloudflared; then
		echo 'cloudflared already installed'
	else
		echo 'installing cloudflared'
		if is-mac; then
			brew install cloudflare/cloudflare/cloudflared
		else
			stderr echo 'installation of cloudflared not yet added for non-macos platforms'
			return 1
		fi
	fi
}

function cloudflare_uninstall {
	if command-exists cloudflared; then
		if is-mac; then
			ok sudo launchctl stop com.cloudflare.cloudflared
			ok sudo launchctl remove com.cloudflare.cloudflared
			ok sudo cloudflared service uninstall
			ok brew uninstall cloudflare/cloudflare/cloudflared
		else
			stderr echo 'uninstallation of cloudflared not yet added for non-macos platforms'
			return 1
		fi
	else
		echo 'cloudflared already uninstalled'
	fi
}

function cloudflare_service {
	if is-file "/usr/local/etc/cloudflared/config.yml"; then
		echo 'cloudflared already configured'
	else
		echo 'configuring cloudflared as service'
		mkdir -p /usr/local/etc/cloudflared
		cat << EOF > /usr/local/etc/cloudflared/config.yml
proxy-dns: true
proxy-dns-upstream:
  - https://1.1.1.1/dns-query
  - https://1.0.0.1/dns-query

EOF
		sudo cloudflared service install
		sudo launchctl start com.cloudflare.cloudflared
	fi
}

function cloudflare_setup {
	cloudflare_install && cloudflare_service
}

function dns_configured {
	out="$(dig -x google.com)"
	if echo "$out" | grep ";; SERVER: 127.0.0.1#53(127.0.0.1)"; then
		echo 'dns is configured and running correctly'
	else
		echo 'dns did not appear to be setup correctly'
		return 1
	fi
}

if test "${1:-}" = "uninstall"; then
	aghome_uninstall
	cloudflare_uninstall
	flush-dns 1.1.1.1
elif dns_configured || (aghome_setup && flush-dns 127.0.0.1 && dns_configured); then
	echo 'SUCCESS dns setup complete'
else
	flush-dns 1.1.1.1
	echo 'FAILURE dns setup failed'
fi