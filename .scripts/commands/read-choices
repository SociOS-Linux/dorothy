#!/usr/bin/env bash
set -e

cursor=0
count="$#"
count="$((count - 2))"
action=""
choices=( "${@:2}" )
declare -A selections

while test "$action" != "done"; do
	clear > /dev/tty

	echo "$1" > /dev/tty

	index=0; for choice in "${choices[@]}"; do
		if test "$index" -eq "$cursor"; then
			echo -n ">" > /dev/tty
		else
			echo -n ' ' > /dev/tty
		fi
		if test -n "${selections[$index]}"; then
			echo -n "*" > /dev/tty
		else
			echo -n ' ' > /dev/tty
		fi
		index="$((index + 1))"
		echo "$choice" > /dev/tty
	done

	action="$(read-arrow)"
	if test "$action" = "left"; then
		if test "$cursor" -ne 0; then
			cursor="$((cursor - 1))"
		fi
	elif test "$action" = "right"; then
		if test "$cursor" -ne "$count"; then
			cursor="$((cursor + 1))"
		fi
	elif test "$action" = "start"; then
		cursor=0
	elif test "$action" = "finish"; then
		cursor="$count"
	elif test "$action" = "select"; then
		if test -n "${selections[$cursor]}"; then
			selections[$cursor]=""
		else
			selection="${choices[$cursor]}"
			selections[$cursor]="$selection"
		fi
	elif test "$action" = "done"; then
		break
	fi
done

clear > /dev/tty

if test "${#selections[@]}" -eq 0; then
	if confirm-positive "You exited without selecting anything, do you wish to select all?" > /dev/tty; then
		clear > /dev/tty
		printf '%s\n' "${choices[@]}"
	else
		clear > /dev/tty
	fi
else
	printf '%s\n' "${selections[@]}"
fi